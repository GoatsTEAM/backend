name: Deploy Changed Services
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # ---------------- 1. какие папки изменились ----------------
    - name: Detect folders
      id: detect
      run: |
        git fetch origin main
        echo "folders=$(git diff --name-only HEAD^ HEAD | cut -d/ -f1 | sort -u | tr '\n' ' ')" >>$GITHUB_OUTPUT

    # ---------------- 2. читаем deploy.yml каждой папки --------
    - name: Collect service configs
      id: collect
      run: |
        pip install yq >/dev/null
        services=()
        composes=()
        for dir in ${{ steps.detect.outputs.folders }}; do
          if [[ -f "$dir/deploy.yml" ]]; then
            svc=$(yq '.service' "$dir/deploy.yml")
            cmp=$(yq '.compose' "$dir/deploy.yml")
            services+=("$svc")
            composes+=("$cmp")
          fi
        done
        echo "services=${services[*]}"  >>$GITHUB_OUTPUT
        echo "composes=${composes[*]}"  >>$GITHUB_OUTPUT

    # ---------------- 3. SSH и выборочный деплой ---------------
    - name: Deploy
      env:
        SERVICES: ${{ steps.collect.outputs.services }}
        COMPOSES: ${{ steps.collect.outputs.composes }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ssh_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.server_ip }} >> ~/.ssh/known_hosts

        i=0
        for svc in $SERVICES; do
          cmp=$(echo $COMPOSES | cut -d' ' -f $((i+1)))
          echo "→ $svc   (compose=$cmp)"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
              ${{ secrets.deploy_user }}@${{ secrets.server_ip }} << EOF
            set -e
            cd $cmp
            if docker compose config --services | grep -qw "$svc"; then
              docker compose build $svc
              docker compose up -d $svc
            else
              echo "Service '$svc' not found in compose — skipped."
            fi
          EOF
          i=$((i+1))
        done