version: "3.9"

##############################################################################
#                          REVERSE-PROXY (Traefik)                           #
##############################################################################
services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--entrypoints.web.address=:80"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--api.dashboard=true"
      - "--log.level=INFO"
    ports:
      - "80:80"     # внешний HTTP
      - "8080:8080" # dashboard  http://<host>:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [proxy]

##############################################################################
#                              MICROSERVICES                                #
#  ▸ каждый блок <имя-сервиса> совпадает с папкой монорепо и service: в     #
#    <папка>/deploy.yml                                                     #
#  ▸ build.context указывает на исходники после git pull                    #
##############################################################################

  test:
    build: ./test
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.test.rule=PathPrefix(`/test`)"
      - "traefik.http.routers.test.entrypoints=web"
      - "traefik.http.services.test.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.test-strip.stripprefix.prefixes=/test"
      - "traefik.http.routers.test.middlewares=test-strip"
    networks: [proxy]

##############################################################################
networks:
  proxy:
    driver: bridge